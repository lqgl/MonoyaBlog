<!doctype html><html lang=zh-hans><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#fcfcfc"><meta name=msapplication-TileColor content="#fcfcfc"><meta itemprop=name content="Share Memory By Communicating"><meta itemprop=description content="英文原文: Share Memory By Communicating 传统的线程模型（例如，在编写Java、C++和Python程序时通常使用）要求程序员使用共享内存在线程之间进行通信。 通常情"><meta itemprop=datePublished content="2022-09-16T10:23:46+08:00"><meta itemprop=dateModified content="2022-09-16T10:23:46+08:00"><meta itemprop=wordCount content="876"><meta itemprop=keywords content><meta property="og:title" content="Share Memory By Communicating"><meta property="og:description" content="英文原文: Share Memory By Communicating 传统的线程模型（例如，在编写Java、C++和Python程序时通常使用）要求程序员使用共享内存在线程之间进行通信。 通常情"><meta property="og:type" content="article"><meta property="og:url" content="https://lqgl.cool/article/codelab-share/"><meta property="article:section" content="article"><meta property="article:published_time" content="2022-09-16T10:23:46+08:00"><meta property="article:modified_time" content="2022-09-16T10:23:46+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Share Memory By Communicating"><meta name=twitter:description content="英文原文: Share Memory By Communicating 传统的线程模型（例如，在编写Java、C++和Python程序时通常使用）要求程序员使用共享内存在线程之间进行通信。 通常情"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><title>Share Memory By Communicating</title><link rel=stylesheet href=https://lqgl.cool/css/style.min.67017a7027c7c05e8e18eb14b38cc24eb9d8c65ce69d53db9e9432c2d580749d.css integrity="sha256-ZwF6cCfHwF6OGOsUs4zCTrnYxlzmnVPbnpQywtWAdJ0=" crossorigin=anonymous></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://lqgl.cool>Lqgl's Blog</a></div><nav class="site-nav hide-in-mobile"><a href=https://lqgl.cool/article/>Article</a>
<a href=https://lqgl.cool/life/>Life</a>
<a href=https://lqgl.cool/tech/>Tech</a>
<a href=https://lqgl.cool/about-me/>About</a>
<a href=https://lqgl.cool/about-friends/>Friend Links</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://twitter.com/ target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a><a href=https://instagram.com/ target=_blank rel="noopener me" title=Instagram><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><path d="M16 11.37A4 4 0 1112.63 8 4 4 0 0116 11.37z"/><line x1="17.5" y1="6.5" x2="17.5" y2="6.5"/></svg></a><a href=https://github.com/lqgl target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://lqgl.cool/article/>Article</a></li><li><a href=https://lqgl.cool/life/>Life</a></li><li><a href=https://lqgl.cool/tech/>Tech</a></li><li><a href=https://lqgl.cool/about-me/>About</a></li><li><a href=https://lqgl.cool/about-friends/>Friend Links</a></li></ul></div><main class="site-main section-inner thin animated fadeIn faster"><h1>Share Memory By Communicating</h1><div class=content><p>英文原文: <a href=https://go.dev/blog/codelab-share>Share Memory By Communicating</a></p><p>传统的线程模型（例如，在编写Java、C++和Python程序时通常使用）要求程序员使用共享内存在线程之间进行通信。
通常情况下，共享数据结构受到锁的保护，而线程将争夺这些锁来访问数据。在某些情况下，使用线程安全的数据结构(如Python的Queue)会使这更容易。</p><p>Go的并发原语 - goroutines和channels - 为构造并发软件提供了一种优雅而独特的方法。(这些概念有一个<a href=https://swtch.com/~rsc/thread/>有趣的历史</a>，
始于C.A.R.Hoare的 <a href=http://www.usingcsp.com/>Communicating Sequential Processes</a>）。
Go鼓励使用通道在goroutine之间传递对数据的引用，而不是明确地使用锁来调解对共享数据的访问。这种方法可以确保在给定时间内只有一个goroutine可以访问数据。
这个概念在<a href=https://go.dev/doc/effective_go.html>Effective Go</a>文件中得到了总结（任何Go程序员都必须阅读）:</p><p><em>不要通过共享内存来进行通信，相反，通过通信来共享内存</em></p><p>考虑一个程序，它轮询一个url列表。在传统的线程环境中，数据的结构可能是这样的:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Resource</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>url</span>        <span class=kt>string</span>
</span></span><span class=line><span class=cl>    <span class=nx>polling</span>    <span class=kt>bool</span>
</span></span><span class=line><span class=cl>    <span class=nx>lastPolled</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Resources</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>data</span> <span class=p>[]</span><span class=o>*</span><span class=nx>Resource</span>
</span></span><span class=line><span class=cl>    <span class=nx>lock</span> <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>然后一个轮询器函数(其中许多会在单独的线程中运行)可能看起来像这样:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Poller</span><span class=p>(</span><span class=nx>res</span> <span class=o>*</span><span class=nx>Resources</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// get the least recently-polled Resource
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=c1>// and mark it as being polled
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>res</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=kd>var</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>Resource</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>v</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>res</span><span class=p>.</span><span class=nx>data</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>v</span><span class=p>.</span><span class=nx>polling</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>continue</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=nx>r</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>v</span><span class=p>.</span><span class=nx>lastPolled</span> <span class=p>&lt;</span> <span class=nx>r</span><span class=p>.</span><span class=nx>lastPolled</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=nx>r</span> <span class=p>=</span> <span class=nx>v</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>r</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=nx>r</span><span class=p>.</span><span class=nx>polling</span> <span class=p>=</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=nx>r</span> <span class=o>==</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>continue</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// poll the URL
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>// update the Resource&#39;s polling and lastPolled
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>res</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>r</span><span class=p>.</span><span class=nx>polling</span> <span class=p>=</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>        <span class=nx>r</span><span class=p>.</span><span class=nx>lastPolled</span> <span class=p>=</span> <span class=nx>time</span><span class=p>.</span><span class=nf>Nanoseconds</span><span class=p>()</span>
</span></span><span class=line><span class=cl>        <span class=nx>res</span><span class=p>.</span><span class=nx>lock</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>这个函数大约有一页那么长，需要更多的细节来完成它。它甚至不包括URL轮询逻辑(它本身只有几行)，也不会优雅地处理耗尽资源池的问题。</p><p>让我们来看看使用Go习语实现的相同功能。在本例中，Poller是一个函数，它从输入通道接收要轮询的资源，并在完成时将它们发送到输出通道。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Resource</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Poller</span><span class=p>(</span><span class=nx>in</span><span class=p>,</span> <span class=nx>out</span> <span class=kd>chan</span> <span class=o>*</span><span class=nx>Resource</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=nx>r</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>in</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// poll the URL
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>        <span class=c1>// send the processed Resource to out
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=nx>out</span> <span class=o>&lt;-</span> <span class=nx>r</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>前面示例中微妙的逻辑明显不存在了，而且我们的Resource数据结构不再包含记账数据。事实上，剩下的都是重要的部分。这应该会让您对这些简单的语言特性的功能有一个初步的了解。</p><p>上面的代码片段有许多遗漏。有关使用这些思想的完整的、惯用的Go程序的演练，请参见Codewalk <a href=https://go.dev/doc/codewalk/sharemem/>Share Memory By Communicating</a>。</p></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://lqgl.cool>Lqgl</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://lqgl.cool/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://lqgl.cool/js/bundle.min.580988ed2982bcbb74a1773c7abea97b43e4c43b9324e10cda0813ec6ec4bb67.js integrity="sha256-WAmI7SmCvLt0oXc8er6pe0PkxDuTJOEM2ggT7G7Eu2c=" crossorigin=anonymous></script></body><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?50c3f3ef571621033fd843f7a435fa32",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></html>